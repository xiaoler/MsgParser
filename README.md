# 一种混合消息语法格式与自定义解析

这里说的主要是针对普通文本混合消息的情况。

### 一、常见IM现状

*微信：*

1.  不支持混合类型消息，如果在输入框输入图文混排消息，会拆分成多条消息发送；
2.  at人只能在消息开头；

*企业微信：*

1.  根据 [企业微信公开API](https://developer.work.weixin.qq.com/document/path/90236) 显示（只是根据这个猜测内部实现），企业微信支持部分html标签（a、div）;
2.  应用消息支持css设置颜色；
3.  企业微信普通消息支持图片、文字、表情、at人混合插入；

*飞书：*

1.  根据 [飞书公开API](https://open.feishu.cn/document/ukTMukTMukTM/uUjNz4SN2MjL1YzM) 显示（只是根据这个猜测内部实现），其自定了部分标签格式（at）；

### 三、设想的消息格式

对于混合消息，设想通过一种自定义标签消息格式的方式来实现，通过内部解析来判断消息内的多种内容格式：

1.  是一种精简版本的xml（有点类似飞书的at标签）；
2.  标签内支持属性标记用于记录信息的id、文件地址、图片宽高设定等信息；

示例：

```xml
123<x-file id=1 name="xxx.otl" url="https://www.xx.ccom/xxx"/>
 2
 <x-mention id=2 name="可乐"/>
我们
```

解析出来的结果就是：

>   123 [xxx](https://www.xx.ccom/xxx) 2 @可乐 我们

### 四、消息解析

使用 [antlr4](https://github.com/antlr/antlr4) 定义的格式编写消息parser的BNF，能够生成go、js、swift、java的多端代码；

根据解析结果，分解消息内容，后台定义存储，客户端定义显示。

### 五、方案优点

1.  消息扩展性强；
2.  统一消息格式语法，保证各端输入输出一致；
3.  自定义解析方便做标签限制，定制解析方案；
4.  规避原生xml/html的一些安全性问题；
5.  解析规则相对简单，性能会比原生xml/html好很多；

### 六、问题

1.  跟xml和html问题一样，tag消息用 `<` 标记开始，所以对普通的 `<` 要进行转义，所以可以使用三个特殊字符字符：`<` (&lt;)、`>` (&gt;)、`&` (&amp;) ，客户端需要对这三个字符的输入和输出转义显示;
2.  卡片消息、富文本消息、markdown消息等应用消息需要单独考虑。
